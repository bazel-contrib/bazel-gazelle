load("@bazel_skylib//:lib.bzl", "shell")

def _gazelle_runner_impl(ctx):
  args = [
      ctx.attr.command,
      "-mode", ctx.attr.mode,
      "-external", ctx.attr.external,
      "-go_prefix", ctx.attr.prefix,
  ]
  if ctx.attr.build_tags:
    args.extend(["-build_tags", ",".join(ctx.attr.build_tags)])
  args.extend(ctx.attr.args)

  out_file = ctx.actions.declare_file(ctx.label.name + ".bash")
  substitutions = {
      "@@ARGS@@": shell.array_literal(args),
      "@@GAZELLE_LABEL@@": shell.quote(str(ctx.attr.gazelle.label)),
      "@@GAZELLE_SHORT_PATH@@": shell.quote(ctx.file.gazelle.short_path),
      "@@GENERATED_MESSAGE@@": """
# Generated by {label}
# DO NOT EDIT
""".format(label = str(ctx.label)),
      "@@RUNNER_LABEL@@": shell.quote(str(ctx.label)),
  }
  ctx.actions.expand_template(
      template = ctx.file._template,
      output = out_file,
      substitutions = substitutions,
      is_executable = True,
  )
  runfiles = ctx.runfiles(files = [ctx.file.gazelle, ctx.file.workspace])
  return [DefaultInfo(
      files = depset([out_file]),
      runfiles = runfiles,
      executable = out_file,
  )]
  
  
_gazelle_runner = rule(
    implementation = _gazelle_runner_impl,
    attrs = {
        "gazelle": attr.label(
            default = "@bazel_gazelle//cmd/gazelle",
            allow_single_file = True,
            cfg = "host",
        ),
        "command": attr.string(
            values = ["update", "fix"],
            default = "update",
        ),
        "mode": attr.string(
            values = ["print", "fix", "diff"],
            default="fix"
        ),
        "external": attr.string(
            values = ["external", "vendored"],
            default="external",
        ),
        "build_tags": attr.string_list(),
        "prefix": attr.string(mandatory = True),
        "extra_args": attr.string_list(),
        "workspace": attr.label(
            mandatory = True,
            allow_single_file = True,
            cfg = "data",
        ),
        "_template": attr.label(
            default="@bazel_gazelle//internal:gazelle.bash.in",
            allow_single_file=True,
        ),
    },
    executable = True,
)

def gazelle(name, **kwargs):
  if "args" in kwargs:
    # The args attribute has special meaning for executable rules, but we
    # always want extra_args here instead.
    if "extra_args" in kwargs:
      fail("{}: both args and extra_args were provided".format(name))
    kwargs["extra_args"] = kwargs["args"]
    kwargs.pop("args")
  _gazelle_runner(
      name = name,
      workspace = "//:WORKSPACE",
      tags = ["manual"],
      **kwargs
  )
